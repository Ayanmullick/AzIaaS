<!DOCTYPE html>
<html lang="en" data-color-mode="dark" data-dark-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/21.1.1/primer.css" integrity="sha512-DQRZcDaNuIkb4JiH6PHalnncWllAK5txkJVocLdyfglJSavW/HxQaJRJeRw5eEPnp+kD1QImSxCwUiOsRrCMEw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        p { overflow-x: auto; white-space: pre-wrap; }
        .log-line-command { color: var(--fgColor-accent, var(--color-accent-fg)); }
        [open] .CheckStep-chevron { transform: rotate(90deg); }
    </style>
</head>

<body>
    <div class="text-mono text-small py-1 my-2 js-checks-log-display-container ml-5 pl-3" id="betweenContent"></div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import { AnsiUp } from "https://cdn.jsdelivr.net/npm/ansi-up@1.0.0/dist/ansi-up.min.js";
        const ansi_up = new AnsiUp();

        document.addEventListener("DOMContentLoaded", () => {
            marked.use({ breaks: true });

            const renderFileContent = async (fileUrl) => {
                try {
                    const response = await fetch(fileUrl);
                    let content = await response.text();
                    createStepsElements();
                    content = formatContent(content);
                    const [completeStepContent, setupStepContent, betweenContent] = getStepsContent(content);
                    document.getElementById("setupStep").innerHTML = marked.parse(setupStepContent);
                    document.getElementById("completeStep").innerHTML = marked.parse(completeStepContent);
                    document.getElementById('betweenContent').innerHTML = marked.parse(betweenContent).replace(/(<\/div>|<\/a>)\s*<br\s*\/?>/g, '$1');
                    document.querySelectorAll("a").forEach(link => link.target = "_blank");
                } catch (error) {
                    console.error('Error fetching or parsing content:', error);
                }
            };

            const createStepsElements = () => {
                const setupStep = document.createElement('div');
                setupStep.id = 'setupStep';
                document.body.appendChild(setupStep);

                const completeStep = document.createElement('div');
                completeStep.id = 'completeStep';
                document.body.appendChild(completeStep);
            };

            const formatContent = (content) => cleanDateTime(replaceGroups(ansi_up.ansi_to_html(content)));

            const cleanDateTime = (result) => result.replaceAll(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{7}Z/g, '');

            const getStepsContent = (content) => {
                content = replaceCommands(content);
                return [
                    content.substring(content.indexOf('Post job')),
                    content.substring(0, content.indexOf("'origin/main'.")),
                    content.substring(content.indexOf("/usr/bin/git"), content.indexOf('Post job'))
                ];
            };

            const replaceCommands = (input) => input.replaceAll(/\[command\](.*)/gm, '<span class="log-line-command">$1</span>');

            const replaceGroups = (input) => input.replace(/##\[\s*group\s*\](.*?)##\[\s*endgroup\s*\]/gs, (match, content) => {
                const lines = content.trim().split('\n').map(line => line.trim()).filter(line => line);
                const summary = lines.shift();
                lines.pop();
                return lines.length > 0
                    ? `<details><summary><u>${summary}</u></summary>${lines.map(text => `
                        <div class='js-check-step-line CheckStep-line d-flex log-line-plain'>
                            <a class="CheckStep-line-number color-fg-muted d-inline-block text-mono text-normal flex-shrink-0"></a>
                            <span class="CheckStep-line-content d-inline-block flex-auto ml-3 js-check-line-content">
                                <span>${text}</span>
                            </span>
                        </div>`).join('')}</details>`
                    : content;
            });

            const path = new URLSearchParams(window.location.search).get("path");
            if (path) renderFileContent(path);
        });
    </script>
</body>

</html>
