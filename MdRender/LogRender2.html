<!DOCTYPE html>
<html lang="en" data-color-mode="dark" data-dark-theme="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/21.1.1/primer.css"
        integrity="sha512-DQRZcDaNuIkb4JiH6PHalnncWllAK5txkJVocLdyfglJSavW/HxQaJRJeRw5eEPnp+kD1QImSxCwUiOsRrCMEw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        p { overflow-x: auto; white-space: pre-wrap; }
        .log-line-command { color: var(--fgColor-accent, var(--color-accent-fg)); }
        [open] .CheckStep-chevron { transform: rotate(90deg); }
    </style>
</head>

<body>
    <div class="text-mono text-small py-1 my-2 js-checks-log-display-container ml-5 pl-3" id="betweenContent"></div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import { AnsiUp } from "https://cdn.jsdelivr.net/npm/ansi-up@1.0.0/dist/ansi-up.min.js";
        const ansi_up = new AnsiUp();

        document.addEventListener("DOMContentLoaded", () => {
            marked.setOptions({ breaks: true });
            const path = new URLSearchParams(window.location.search).get("path");
            if (path) fetchAndRenderContent(path);
        });

        async function fetchAndRenderContent(fileUrl) {
            try {
                const response = await fetch(fileUrl);
                let content = await response.text();
                content = ansi_up.ansi_to_html(content);
                content = formatContent(content);
                const [setupStepContent, completeStepContent, betweenContent] = getStepsContent(content);

                renderSteps(setupStepContent, completeStepContent, betweenContent);
            } catch (error) {
                console.error('Error fetching or rendering content:', error);
            }
        }

        function formatContent(content) {
            return content
                .replace(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{7}Z/g, '')
                .replaceAll(/\[command\](.*)/gm, '<span class="log-line-command">$1</span>')
                .replace(/##\[\s*group\s*\](.*?)##\[\s*endgroup\s*\]/gs, (match, innerContent) => {
                    const [summary, ...lines] = innerContent.trim().split('\n').map(line => line.trim());
                    return `<details><summary><u>${summary}</u></summary>${lines.map(line =>
                        `<div class="js-check-step-line CheckStep-line d-flex log-line-plain">
                            <a class="CheckStep-line-number color-fg-muted d-inline-block text-mono text-normal flex-shrink-0"></a>
                            <span class="CheckStep-line-content d-inline-block flex-auto ml-3 js-check-line-content">${line}</span>
                         </div>`).join('')}</details>`;
                });
        }

        function getStepsContent(content) {
            const setupStepEnd = content.indexOf("'origin/main'.");
            const completeStepStart = content.indexOf('Post job');
            return [
                content.slice(0, setupStepEnd),
                content.slice(completeStepStart),
                content.slice(content.indexOf("/usr/bin/git"), completeStepStart)
            ];
        }

        function renderSteps(setupContent, completeContent, betweenContent) {
            const container = document.getElementById('betweenContent');
            container.innerHTML = marked.parse(betweenContent).replace(/(<\/div>|<\/a>)\s*<br\s*\/?>/g, '$1');
            createStepDetails(container, 'setupStep', 'Setup, Checkout', marked.parse(setupContent));
            createStepDetails(container, 'completeStep', 'Checkout, Complete', marked.parse(completeContent));

            document.querySelectorAll("a").forEach(link => link.setAttribute("target", "_blank"));
        }

        function createStepDetails(referenceNode, stepId, stepText, stepContent) {
            const detailsElement = document.createElement('details');
            detailsElement.className = 'Details-element CheckStep rounded-2 details-reset js-checks-log-details px-2 border';
            detailsElement.innerHTML = `
                <summary class="CheckStep-header p-2 mb-1 rounded-2 js-check-step-summary uxr_CheckStep-header mx-2">
                    <div class="d-flex flex-items-center">
                        <svg class="octicon octicon-chevron-right js-check-step-chevron mr-2 flex-shrink-0 CheckStep-chevron" viewBox="0 0 16 16" width="16" height="16">
                            <path fill-rule="evenodd" d="M6.22 3.22a.75.75 0 011.06 0l4.25 4.25a.75.75 0 010 1.06l-4.25 4.25a.75.75 0 01-1.06-1.06L9.94 8 6.22 4.28a.75.75 0 010-1.06z"></path>
                        </svg>
                        <svg class="octicon octicon-check-circle-fill mr-3 flex-shrink-0 ml-1" title="This step passed" viewBox="0 0 16 16" width="16" height="16">
                            <path d="M8 16A8 8 0 1 1 8 0a8 8 0 0 1 0 16Zm3.78-9.72a.751.751 0 0 0-.018-1.042.751.751 0 0 0-1.042-.018L6.75 9.19 5.28 7.72a.751.751 0 0 0-1.042.018.751.751 0 0 0-.018 1.042l2 2a.75.75 0 0 0 1.06 0Z"></path>
                        </svg>
                        <span class="flex-1 ml-n1 mr-1 css-truncate css-truncate-overflow user-select-none">${stepText}</span>
                    </div>
                </summary>
                <div class="text-mono text-small py-1 my-2 js-checks-log-display-container ml-5 pl-3">${stepContent}</div>`;
            referenceNode.parentNode.insertBefore(detailsElement, referenceNode);
        }
    </script>
</body>

</html>
